var events = [{startYear: "900", endYear: "910", name: "some war"}, {startYear: "920", endYear: "920", name: "some 2nd war"}];

var persons = [{
    "name": "Leopold III. (13)",
    "died": 1136,
    "born": 1073,
    "gender": "man",
    "id" : 1,
    "marriages": [{
        "spouse": {
            "name": "? v. Perg (N)",
            "gender": "woman",
            "died": 1100,
            "born": 1073,
            "marriage": 1085,
            "id" : 2,
        },
        "children": [{
            "name": "Adalbert (14)",
            "born": 1090,
            "died": 1138,
            "gender": "man",
            "father" : 1, 
            "id" : 3,
            "marriages": [{
                "spouse": {
                    "name": "Adelheid (N)",
                    "gender": "woman",
                    "born": 1100,
                    "died": 1125,
                    "marriage": 1120,
                    "id" : 4,
                }
            },{
                "spouse": {
                    "name": "Sophie (55)",
                    "gender": "woman",
                    "born": 1110,
                    "died": 1145,
                    "marriage": 1131,
                    "id" : 5,
                }
            }]
        }]
    },{
        "spouse": {
            "name": "Agnes (44)",
            "gender": "woman",
            "died": 1177,
            "born": 1107,
            "marriage": 1120,
            "id" : 6,
        },
        "children": [{
            "name": "Heinrich II. (19)",
            "died": 1177,
            "born": 1130,
            "gender": "man",
            "father" : 1,
            "id" : 7,
            "marriages": [{
                "spouse": {
                    "name": "Gertrud (56)",
                    "born": 1120,
                    "died": 1150,
                    "gender": "woman",
                    "marriage": 1140,
                    "id" : 8,
                },
                "children": [{
                    "name": "Richardis (N)",
                    "born": 1145,
                    "died": 1185,
                    "gender": "woman",
                    "father" : 7,
                    "id" : 9,
                }]
            },{
                "spouse": {
                    "name": "Theodora (57)",
                    "born": 1130,
                    "died": 1183,
                    "gender": "woman",
                    "marriage": 1160,
                    "id" : 10,
                },
                "children": [{
                    "name": "Agnes (58)",
                    "born": 1165,
                    "died": 1184,
                    "gender": "woman",
                    "id" : 11,
                    "father" : 7,
                },{
                    "name": "Leopold V. (20)",
                    "died": 1194,
                    "born": 1165,
                    "gender": "man",
                    "id" : 12,
                    "father" : 7,
                    "marriages": [{
                        "spouse": {
                            "name": "Helene (60)",
                            "gender": "woman",
                            "born" : 1150,
                            "died" : 1200,
                            "marriage": 1180,
                            "id" : 13,
                        },
                        "children": [{
                            "name": "Friedrich I. (23)",
                            "died": 1198,
                            "born": 1180,
                            "gender": "man",
                            "id" : 14,
                            "father" : 12,
                        },{
                            "name": "Leopold IV. (24)",
                            "died": 1230,
                            "born": 1180,
                            "gender": "man",
                            "id" : 15,
                            "father" : 12,
                            "marriages": [{
                                "spouse": {
                                    "name": "Theodora (63)",
                                    "born": 1200,
                                    "died": 1246,
                                    "gender": "woman",
                                    "marriage": 1210,
                                    "id" : 16,
                                },
                                "children": [{
                                    "name": "Margarethe (64)",
                                    "born": 1215,
                                    "died": 1266,
                                    "gender": "woman",
                                    "id" : 17,
                                    "father" : 15,
                                },{
                                    "name": "Agnes (65)",
                                    "born": 1215,
                                    "died": 1226,
                                    "gender": "woman",
                                    "id" : 18,
                                    "father" : 15,
                                },{
                                    "name": "Leopold (25)",
                                    "born": 1215,
                                    "died": 1230,
                                    "gender": "man",
                                    "id" : 19,
                                    "father" : 15,
                                },{
                                    "name": "Heinrich (26)",
                                    "born": 1215,
                                    "died": 1250,
                                    "gender": "man",
                                    "id" : 20,
                                    "father" : 15,
                                    "marriages": [{
                                        "spouse": {
                                            "name": "Agnes (68V)",
                                            "gender": "woman",
                                            "born" : 1200,
                                            "died" : 1250,
                                            "marriage": 1220,
                                            "id" : 21,
                                        },
                                        "children" : [{
                                            "name" : "Gertrud (69)",
                                            "gender" : "woman",
                                            "born" : 1230,
                                            "died" : 1250,
                                            "id" : 22,
                                            "father" : 20,
                                        }]
                                    }]
                                },{
                                    "name": "Friedrich II. (27)",
                                    "died": 1246,
                                    "born": 1215,
                                    "gender": "man",
                                    "id" : 23,
                                    "father" : 15,
                                    "marriages" : [{
                                        "spouse" : {
                                            "name" : "Sophie (73V)",
                                            "gender" : "woman",
                                            "born" : 1200,
                                            "died" : 1230,
                                            "marriage": 1220,
                                            "id" : 24,
                                        }
                                    },{
                                        "spouse" : {
                                            "name" : "Agnes v. Meranien (72)",
                                            "gender" : "woman",
                                            "born": 1200,
                                            "died" : 1270,
                                            "marriage": 1235,
                                            "id" : 25,
                                        }
                                    }]
                                },{
                                    "name": "Konstanze (66)",
                                    "born": 1215,
                                    "died": 1243,
                                    "gender": "woman",
                                    "id" : 26,
                                    "father" : 15,
                                },{
                                    "name": "Gertrud (67)",
                                    "born" : 1215,
                                    "died": 1241,
                                    "gender": "woman",
                                    "id" : 27,
                                    "father" : 15,
                                }]
                            }]
                        },{
                            "name": "Agnes (61V)",
                            "gender": "woman",
                            "born": 1180,
                            "died": 1200,
                            "id" : 28,
                        }]
                    }]
                },{
                    "name": "Heinrich d.Ã„. (21)",
                    "born": 1150,
                    "died": 1223,
                    "gender": "man",
                    "id" : 29,
                    "father" : 7,
                    "marriages": [{
                        "spouse": {
                            "name": "Richza (62)",
                            "born": 1100,
                            "died": 1182,
                            "gender": "woman",
                            "marriage": 1155,
                            "id" : 30,
                        },
                        "children": [{
                            "name": "Heinrich d.J. (22)",
                            "born": 1160,
                            "died": 1236,
                            "gender": "man",
                            "id" : 31,
                        }]
                    }]
                }]
            }]
        },{
            "name": "Leopold IV. (15)",
            "died": 1141,
            "born": 1108,
            "gender": "man",
            "father" : 1,
            "id" : 32,
            "marriages": [{
                "spouse": {
                    "name": "Maria (59)",
                    "gender": "woman",
                    "died": 1141,
                    "born": 1108,
                    "marriage": 1120,
                    "id" : 33,
                }
            }]
        },{
            "name": "Berta (45)",
            "born": 1100,
            "died": 1150,
            "gender": "woman",
            "father" : 1, 
            "id" : 34,
        },{
            "name": "Agnes (46)",
            "born": 1100,
            "died": 1157,
            "gender": "woman",
            "father" : 1, 
            "id" : 35,
        },{
            "name": "Otto (16)",
            "died": 1158,
            "born": 1112,
            "gender": "man",
            "father" : 1, 
            "id" : 36,
        },{
            "name": "Konrad (17)",
            "died": 1168,
            "born": 1115,
            "gender": "man",
            "id" : 37,
        },{
            "name": "Elisabeth (48)",
            "born": 1100,
            "died": 1143,
            "gender": "woman",
            "father" : 1, 
            "id" : 38,
        },{
            "name": "Gertrud (47)",
            "born": 1100,
            "died": 1151,
            "gender": "woman",
            "father" : 1, 
            "id" : 39,
        },{
            "name": "Judith (49)",
            "born": 1100,
            "died": 1191,
            "gender": "woman",
            "father" : 1, 
            "id" : 40,
        }]
    }]
}];

var dataArray = [];
dataArray[0] = [{x:5, y:5}, {x:10, y:5}, {x:15, y:10}, {x:50, y:10}]; // first: birth, second & third: calculation for mariage, forth: dead
dataArray[1] = [{x:10, y:25}, {x:15, y:20}, {x:60, y:20}];
dataArray[2] = [{x:30, y:45}, {x:100, y:45}];

var interpolateTypes = [d3.curveLinear, d3.curveNatural, d3.curveStep, d3.curveBasis, d3.curveBundle, d3.curveCardinal];
var stringDates = ['1000', '1300'];
var parseDate = d3.timeParse("%Y");

//var minDate = d3.min(data, function(d){ return d.month; });
//var maxDate = d3.max(data, function(d){ return d.month; });

//var j = d3.scaleTime().domain(d3.extent(stringDates, function(d){ return parseDate(d); })).range([0,chartWidth]);

var svgHeight = 2000;
var svgWidth = 2000;

var x = d3.scaleTime()
.domain(d3.extent(stringDates, function(d){return parseDate(d)}))
.range([0, svgWidth]); // heighest x * 6


// get the x-coordinates depending on year
var whichX = d3.scaleLinear()
    .domain([1000, 1300]) // min and max year of data set
    .range([0, svgWidth]); // min and max of svg

var personArray = [];
var personInfoArray = [];
var itterator = 0;
var startY = 20;
var marriageXDiff = 5;
var marriageYDiff = 10;
var yDiff = 50;
var marriageCount = 1;

var childArray = [];
var showChildArray = [];
var saveChildData = [{x: "", y: ""}, {x: "", y: ""}];
var isChild = false;
var isFather = false;
var fatherArray = [];


persons.forEach(person => {
   // console.log(person);
    //console.log(person.name + " " + person.born + " " + whichX(person.born));
    isMarried(person);
});

function isMarried(person){
    if(typeof person.marriages != "undefined"){
        console.log("ist verheiratet");
        console.log(person.name);
        if(typeof person.marriages[0].children !== "undefined"){
            isFather = true;
            console.log("Father");
        }

        marriageCount = 1;
        pushInArray(person, "married");
        
        person.marriages.forEach(marriage => {
            console.log("verheiratet mit");
            console.log(marriage.spouse.name);

            pushInArray(marriage.spouse, "spouse");

            if(typeof marriage.children !== "undefined"){
                console.log("hat Kinder");
                childArray.push(marriage);
            }else{
                console.log("keine Kinder");
            }
        });
        
        childArray.forEach(spouse => {
            childArray = [];
            console.log("childArray is cleared");

            spouse.children.forEach(child => {
                isChild = true;
                console.log("Kind");
                console.log(child.name + " " + child.born + " " + whichX(child.born));
                isMarried(child);
            });
        });
    }else{
        console.log("nicht verheiratet");
        pushInArray(person, "child");
    }
}

function pushInArray(person, type){
    console.log("pushinarray");
    console.log(person);
    // x1 - x-Child  y1 - middle of Father/Mother y3
    // x2 - x-Child  y2 - y1 child
    if(isChild){
        isChild = false;
        getFatherById(person.father);
        var fatherY = getFatherY(father);
        showChildArray.push([{x: whichX(person.born), y: fatherY + 15}, 
            {x: whichX(person.born), y: startY}]);
    }

    switch (type) {
        case "child":
            console.log("child");
            personArray[itterator] = [
                {x: whichX(person.born), y: startY, gender: person.gender}, 
                {x: whichX(person.died), y: startY},
            ];
            personInfoArray[itterator] = {name: person.name, gender: person.gender, x: whichX(person.born), y: startY};

            console.log("in nicht verheiratet");
            console.log(person.name);
            startY += yDiff;
            itterator++;
            break;
        
        case "spouse":
            console.log("spouse");
            
            var marriageX1 = whichX(person.marriage) - marriageXDiff;
            var marriageX2 = whichX(person.marriage) + marriageXDiff;
            var marriageY = startY - marriageYDiff - yDiff*(marriageCount-1);
            
            personArray[itterator] = [
                {x: whichX(person.born), y: startY, gender: person.gender}, // born
                {x: marriageX1, y: startY}, // marriage 1
                {x: marriageX2, y: marriageY}, // marriage 2
                {x: whichX(person.died), y: marriageY}
            ];
            personInfoArray[itterator] = {name: person.name, gender: person.gender, x: whichX(person.born), y: startY};
            
            startY += yDiff;
            itterator++;
            marriageCount++;
            break;
    
        default:
            console.log("default");
            var marriageX1 = whichX(person.marriages[marriageCount-1].spouse.marriage) - marriageXDiff;
            var marriageX2 = whichX(person.marriages[marriageCount-1].spouse.marriage) + marriageXDiff;
            var marriageY = startY + marriageYDiff;
            saveChildData[0].y = marriageY + 5;

            fatherArray.push({y: marriageY, id: person.id});

            personArray[itterator] = [
                {x: whichX(person.born), y: startY, gender: person.gender}, 
                {x: marriageX1, y: startY}, // marriage 1
                {x: marriageX2, y: marriageY}, // marriage 2
                {x: whichX(person.died), y: marriageY},
            ];
            personInfoArray[itterator] = {name: person.name, gender: person.gender, x: whichX(person.born), y: startY};
            startY += yDiff;
            itterator++;
            break;
    }
}
var father;
var myId;

function getFatherById(myIdF){
    myId = myIdF;
    console.log("search " + myId);
    persons.forEach(person => {
        getFatherByIdRecursive(person);
    });
}

function getFatherByIdRecursive(person){
    if(person.id == myId){
        console.log("id found");
        console.log(person);
        father = person;
    }
    if(typeof person.marriages != "undefined"){
        person.marriages.forEach(marriage => {
            if(typeof marriage.children !== "undefined"){
                marriage.children.forEach(child => {
                    if(child.id == myId){
                        console.log("id found");
                        console.log(child);
                        father = child;
                    }else{
                        getFatherByIdRecursive(child);
                    }
                });
            }
        });
    }
}

function getFatherY(fatherSample){
    console.log(fatherSample);
    var fatherY = "";
    fatherArray.forEach(father => {
        if(father.id == fatherSample.id){
            fatherY = father.y;
        }
    });
    return fatherY;
}

var xAxis = d3.axisBottom(x);

var svg = d3.select("body").append("svg")
    .attr("height", svgHeight)
    .attr("width", svgWidth);

var line = d3.line()
    .x(function(d, i){ return d.x; })
    .y(function(d, i){ return d.y; })
    .curve(d3.curveLinear); // generates a path element which is a line

var chartGroup = svg.append("g")
    .attr("class", "group")
    .attr("transform", "translate(0,0)");

var firstGroups = chartGroup.selectAll("g")
    .data(personArray)
    .enter().append("g")
        .attr("class", function(d,i){ return "firstLevelGroup"+i;});

var secondGroups = firstGroups.append("path")
    .attr("fill", "none")
    .attr("stroke", function(d) {
        if(d[0].gender == "man"){
            return "blue";
        }else{
            return "red";
        }
    })
    .attr("stroke-width", "25")
    .attr("d", function(d){ return line(d); });
   
var thirdGroup = chartGroup.selectAll("g.third")
    .data(showChildArray)
    .enter().append("g")
        .attr("class", "third");
var fourthGroup = thirdGroup.append("path")
    .attr("fill", "none")
    .attr("stroke", "green")
    .attr("stroke-width", "1")
    .attr("stroke-dasharray", "10,10")
    .attr("d", function(d){ return line(d); });

// Adds names to 
    chartGroup.selectAll("text")
        .data(personInfoArray)
        .enter()
        .append("text")
            .text(function(d) { return d.name; })
            .attr("x", function(d) {return d.x;})
            .attr("y", function(d) {return d.y;})
            .attr("fill", "white");

/*
for(var i=0; i < personArray.length; i++){
    firstGroups.selectAll("circle.grp")
        .data(personArray[i])
        .enter()
        .append("circle")
            .attr("class", function(d, j){ return "grp"+j; })
            .attr("cx", function(d){ return d.x; })
            .attr("cy", function(d){ return d.y; })
            .attr("r", "5")
            .attr("fill", "yellow");
}*/


var axisGroup = svg.append("svg")
//d3.select("body").append("svg").attr("height", "100").attr("width", svgWidth)
//    chartGroup.append("g")
    .attr("class", "x axis").attr("transform", "translate(0,0)").style("position", "fixed").style("top", "0").style("left", "0")
    .call(xAxis);

